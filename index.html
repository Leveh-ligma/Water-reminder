<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíß Water Intake & Reminder</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for mobile-first design */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff; /* Light blue background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 420px; /* Mobile width constraint */
            background-color: white;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom styling for the goal ring/display */
        .progress-ring {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 1.5rem;
        }
        .progress-ring svg {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: center;
        }
        /* Style for the Add Water button */
        #addWaterBtn {
            transition: all 0.2s ease-in-out;
        }
        #addWaterBtn:hover {
            box-shadow: 0 4px 15px -5px #0ea5e9;
        }
        #addWaterBtn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
</head>
<body>

<div class="container">
    <h1 class="text-3xl font-extrabold text-center text-blue-600 mb-2">
        üíß Hydration Tracker
    </h1>
    <p id="auth-status" class="text-center text-xs text-gray-500 mb-4"></p>

    <!-- Progress Display -->
    <div class="progress-ring">
        <svg viewBox="0 0 36 36" class="absolute inset-0">
            <circle class="text-gray-200" cx="18" cy="18" r="15.91549430918954" fill="none" stroke="currentColor" stroke-width="2"></circle>
            <circle id="progressCircle" class="progress-ring-circle text-blue-500" cx="18" cy="18" r="15.91549430918954" fill="none" stroke="currentColor" stroke-width="3"
                stroke-dasharray="100" stroke-dashoffset="100"></circle>
        </svg>
        <div class="absolute inset-0 flex flex-col justify-center items-center">
            <div id="progressText" class="text-4xl font-bold text-blue-600">0/9</div>
            <div class="text-sm text-gray-500">Glasses</div>
        </div>
    </div>

    <!-- Main Action Button -->
    <button id="addWaterBtn" class="w-full py-4 text-white font-bold rounded-xl shadow-lg bg-blue-500 hover:bg-blue-600 disabled:opacity-50 transition duration-150 mb-6">
        Log 1 Glass
    </button>

    <!-- Settings and Notifications -->
    <div class="bg-blue-50 p-4 rounded-xl shadow-inner border border-blue-200">
        <h2 class="text-xl font-semibold text-blue-700 mb-3 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Reminder Settings
        </h2>

        <div class="flex items-end space-x-2 mb-4">
            <div class="flex-grow">
                <label for="intervalInput" class="block text-sm font-medium text-gray-700">Interval (Minutes)</label>
                <input type="number" id="intervalInput" value="60" min="15" max="360" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
            </div>
            <button id="toggleReminderBtn" class="px-4 py-2 text-white font-semibold rounded-lg shadow transition duration-150 bg-green-600 hover:bg-green-700">
                Start
            </button>
        </div>

        <p id="reminderStatus" class="text-sm text-gray-600 mt-2">
            Status: Reminders are currently <span class="font-bold text-red-500">OFF</span>.
        </p>
        <p class="text-xs text-yellow-700 mt-3 p-2 bg-yellow-100 rounded-lg">
            ‚ö†Ô∏è **Note:** Reminders use the browser's Notification API. The tab must remain open for them to function. You will be prompted to allow notifications.
        </p>
    </div>

    <!-- Utilities -->
    <div class="mt-6 flex justify-between">
        <button id="resetBtn" class="text-sm text-red-500 hover:text-red-700 font-medium">
            Reset Daily Goal
        </button>
        <p class="text-xs text-gray-400">User ID: <span id="userIdDisplay">Loading...</span></p>
    </div>

    <!-- Message Box for Alerts (replacing alert()) -->
    <div id="messageBox" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full">
            <h3 id="messageTitle" class="text-lg font-bold mb-3 text-blue-600"></h3>
            <p id="messageContent" class="text-gray-700 mb-4"></p>
            <button onclick="document.getElementById('messageBox').classList.add('hidden')" class="w-full py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600">
                OK
            </button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // setLogLevel('Debug'); // Uncomment for debugging Firebase logs

    // --- Configuration and Global Variables ---
    const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const FIREBASE_CONFIG = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const INITIAL_AUTH_TOKEN = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    const GOAL_GLASSES = 9;
    let db, auth;
    let userId = null;
    let glassesDrunk = 0;
    let intervalMinutes = 60;
    let timerId = null;
    let isReminderActive = false;

    // --- DOM Elements ---
    const progressTextEl = document.getElementById('progressText');
    const progressCircleEl = document.getElementById('progressCircle');
    const addWaterBtn = document.getElementById('addWaterBtn');
    const resetBtn = document.getElementById('resetBtn');
    const intervalInput = document.getElementById('intervalInput');
    const toggleReminderBtn = document.getElementById('toggleReminderBtn');
    const reminderStatusEl = document.getElementById('reminderStatus');
    const userIdDisplayEl = document.getElementById('userIdDisplay');
    const authStatusEl = document.getElementById('auth-status');

    // --- Utility Functions ---

    /** Displays a custom modal message. */
    function showMessage(title, content) {
        document.getElementById('messageTitle').textContent = title;
        document.getElementById('messageContent').textContent = content;
        document.getElementById('messageBox').classList.remove('hidden');
        document.getElementById('messageBox').classList.add('flex');
    }

    /** Updates the progress ring and text. */
    function updateUI() {
        progressTextEl.textContent = `${glassesDrunk}/${GOAL_GLASSES}`;
        
        const percentage = Math.min(100, (glassesDrunk / GOAL_GLASSES) * 100);
        const circumference = 2 * Math.PI * 15.91549430918954; // Calculated based on r=15.915...
        const offset = circumference - (percentage / 100) * circumference;
        
        progressCircleEl.style.strokeDashoffset = offset;
        progressCircleEl.classList.toggle('text-green-500', glassesDrunk >= GOAL_GLASSES);
        progressCircleEl.classList.toggle('text-blue-500', glassesDrunk < GOAL_GLASSES);
        
        addWaterBtn.disabled = glassesDrunk >= GOAL_GLASSES;
        addWaterBtn.textContent = glassesDrunk >= GOAL_GLASSES ? 'Goal Reached! üéâ' : 'Log 1 Glass';
    }

    /** Sets the reminder UI state. */
    function setReminderUI(isActive) {
        isReminderActive = isActive;
        if (isActive) {
            toggleReminderBtn.textContent = 'Stop';
            toggleReminderBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            toggleReminderBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            const statusText = `<span class="font-bold text-green-600">ON</span>, running every ${intervalMinutes} minutes.`;
            reminderStatusEl.innerHTML = `Status: Reminders are currently ${statusText}`;
        } else {
            toggleReminderBtn.textContent = 'Start';
            toggleReminderBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            toggleReminderBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            reminderStatusEl.innerHTML = `Status: Reminders are currently <span class="font-bold text-red-500">OFF</span>.`;
        }
    }

    // --- Notification & Reminder Logic ---

    /** Request permission for browser notifications. */
    function requestNotificationPermission() {
        if (!("Notification" in window)) {
            showMessage("Browser Alert", "This browser does not support desktop/browser notifications.");
            return Promise.resolve(false);
        }
        return Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                return true;
            } else if (permission === "denied") {
                showMessage("Permission Denied", "You must allow notifications in your browser settings to receive reminders.");
                return false;
            } else {
                return false;
            }
        });
    }

    /** Sends a browser notification. */
    function sendWaterReminder() {
        if (glassesDrunk < GOAL_GLASSES && Notification.permission === "granted") {
            try {
                new Notification("üíß Hydration Reminder!", {
                    body: `Time to drink water! You've had ${glassesDrunk} out of ${GOAL_GLASSES} glasses today.`,
                    icon: 'https://placehold.co/48x48/0ea5e9/ffffff?text=üíß',
                    tag: 'water-reminder'
                });
            } catch (error) {
                console.error("Failed to send notification:", error);
            }
        }
    }

    /** Starts the recurring reminder interval. */
    async function startReminders() {
        if (timerId) clearInterval(timerId); // Clear any existing timer

        const isPermitted = await requestNotificationPermission();
        if (!isPermitted) return;

        intervalMinutes = parseInt(intervalInput.value);
        if (intervalMinutes < 15) {
            showMessage("Invalid Interval", "Please set an interval of 15 minutes or more.");
            return;
        }

        // Save the new interval to Firestore
        await saveSettings();

        // Start the timer
        sendWaterReminder(); // Send immediately upon start
        timerId = setInterval(() => {
            sendWaterReminder();
        }, intervalMinutes * 60 * 1000); // Minutes to milliseconds

        setReminderUI(true);
        showMessage("Reminders Started", `You will now receive a reminder every ${intervalMinutes} minutes.`);
    }

    /** Stops the recurring reminder interval. */
    function stopReminders() {
        if (timerId) {
            clearInterval(timerId);
            timerId = null;
        }
        setReminderUI(false);
        showMessage("Reminders Stopped", "Hydration reminders have been turned off.");
    }

    /** Toggle reminder functionality. */
    function handleReminderToggle() {
        if (isReminderActive) {
            stopReminders();
        } else {
            startReminders();
        }
    }

    // --- Firestore Data Operations ---

    /** Gets the document reference for the user's settings. */
    function getSettingsDocRef(uid) {
        if (!db) return null;
        // Private data path: /artifacts/{appId}/users/{userId}/water_tracker/settings
        return doc(db, `artifacts/${APP_ID}/users/${uid}/water_tracker`, 'settings');
    }

    /** Saves current state to Firestore. */
    async function saveSettings() {
        if (!userId || !db) return;
        const settingsRef = getSettingsDocRef(userId);

        try {
            await updateDoc(settingsRef, {
                glassesDrunk: glassesDrunk,
                intervalMinutes: intervalMinutes,
                lastUpdate: new Date().getTime(),
            });
        } catch (error) {
            // This happens if the document doesn't exist yet, so we create it.
            await setDoc(settingsRef, {
                glassesDrunk: glassesDrunk,
                intervalMinutes: intervalMinutes,
                lastUpdate: new Date().getTime(),
            });
        }
    }

    /** Sets up real-time listener for user data. */
    function setupDataListener(uid) {
        if (!db || !uid) return;

        const settingsRef = getSettingsDocRef(uid);

        onSnapshot(settingsRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                glassesDrunk = data.glassesDrunk || 0;
                intervalMinutes = data.intervalMinutes || 60;
                intervalInput.value = intervalMinutes;

                // Stop and restart the timer if it was active and the interval changed
                if (isReminderActive) {
                    stopReminders();
                    startReminders(); // This automatically uses the new intervalMinutes
                }
            } else {
                // Initialize default settings if document doesn't exist
                glassesDrunk = 0;
                intervalMinutes = 60;
                setDoc(settingsRef, { glassesDrunk: 0, intervalMinutes: 60, lastUpdate: new Date().getTime() });
            }
            updateUI();
        }, (error) => {
            console.error("Error listening to Firestore:", error);
            authStatusEl.textContent = "Error loading data. Check console.";
        });
    }

    // --- Event Handlers ---

    /** Logs one glass of water. */
    async function handleAddWater() {
        if (glassesDrunk < GOAL_GLASSES) {
            glassesDrunk++;
            updateUI();
            await saveSettings();

            if (glassesDrunk === GOAL_GLASSES) {
                if (isReminderActive) {
                    stopReminders(); // Automatically stop reminders when goal is reached
                    showMessage("Goal Complete!", `You've reached your daily goal of ${GOAL_GLASSES} glasses! Reminders stopped.`);
                }
            }
        }
    }

    /** Resets the daily goal. */
    async function handleResetGoal() {
        glassesDrunk = 0;
        updateUI();
        await saveSettings();
        
        // Restart reminders if they were active
        if (isReminderActive) {
            stopReminders();
            startReminders();
        }

        showMessage("Goal Reset", "Your daily water goal has been reset to 0 glasses.");
    }

    // --- Initialization ---

    async function initializeFirebase() {
        try {
            if (!FIREBASE_CONFIG.apiKey) {
                 authStatusEl.textContent = "Error: Firebase config missing.";
                 return;
            }

            const app = initializeApp(FIREBASE_CONFIG);
            db = getFirestore(app);
            auth = getAuth(app);

            authStatusEl.textContent = "Authenticating...";

            // Authenticate user
            if (INITIAL_AUTH_TOKEN) {
                await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
            } else {
                await signInAnonymously(auth);
            }

            // Set up Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplayEl.textContent = userId.substring(0, 8) + '...';
                    authStatusEl.textContent = "Status: Connected and ready.";
                    setupDataListener(userId);
                } else {
                    userId = null;
                    userIdDisplayEl.textContent = 'Anon';
                    authStatusEl.textContent = "Status: Signed out. Data will not persist.";
                }
                updateUI();
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            authStatusEl.textContent = `Error: ${error.message}`;
        }
    }

    // --- Bind Events ---
    function bindEvents() {
        addWaterBtn.addEventListener('click', handleAddWater);
        resetBtn.addEventListener('click', handleResetGoal);
        toggleReminderBtn.addEventListener('click', handleReminderToggle);
    }

    // Start everything once the document is ready
    window.onload = () => {
        initializeFirebase();
        bindEvents();
        updateUI();
        setReminderUI(false); // Initial state is OFF
    };

</script>
</body>
</html>